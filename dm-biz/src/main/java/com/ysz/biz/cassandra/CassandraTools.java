package com.ysz.biz.cassandra;

import it.unimi.dsi.fastutil.longs.LongArrayList;
import it.unimi.dsi.fastutil.longs.LongComparators;
import java.nio.ByteBuffer;

public class CassandraTools {

  private LongArrayList ring;

  public CassandraTools() {
    String data = "-9201986866562414835,-9140292563004657413,-9128621767779563220,-9021879849731574616,-9018982628952758367,-9018003804688715102,-8989281626083210466,-8938729759624060223,-8929792717443316725,-8920674660301855792,-8900813601146096098,-8893215246322806434,-8869139592972755876,-8862883103807607292,-8772702743614170296,-8769150524459636364,-8765090146567876336,-8764902923183382890,-8733214767277041498,-8722115314547518373,-8711434508441322592,-8668325199942580963,-8646907956730954436,-8634682623201350706,-8599627143634494582,-8591277522285196957,-8577003653713351637,-8526626817131122706,-8491985854544239613,-8478883990787187626,-8469805658109123093,-8446755975248044156,-8424244305675488921,-8416715224921828937,-8411058150378156231,-8393350181619210144,-8384295705523677988,-8383899757980122048,-8374432839390071265,-8351499170945964747,-8337013110001842144,-8334931460502615294,-8330454738107996732,-8296504093836781813,-8279490422711826503,-8269474272290868740,-8267536421569475223,-8260511187372114905,-8258585841545859207,-8215012213384155830,-8209076644539219919,-8204746729570586149,-8200782989199227927,-8162685145740421837,-8143661424928843150,-8124417709875824625,-8123470071613376632,-8110640038463682191,-8098604936966723366,-8072704829509199503,-8061300390912808159,-8052390222552733503,-7988840508668472781,-7964906596790821582,-7963141110898304010,-7954096820397420433,-7937207163128624967,-7922307710494783511,-7913598696354640912,-7906205777867203393,-7882818525114899674,-7870702634650898989,-7851448051098104637,-7848734063647940160,-7841348195404489840,-7838554870697589731,-7774834666752348533,-7766044004644982874,-7735032122401347036,-7724953795399790370,-7715456189028249411,-7697045946818613299,-7666293875622299566,-7663224208409590158,-7645319371841582590,-7615939057362215244,-7593068609183961399,-7579772746678486751,-7564361639176664909,-7522104875472811980,-7520086865002009332,-7517563002209467110,-7516805434917113241,-7509021080784588341,-7502763382576684718,-7501181241682842474,-7485348764527118884,-7475273173441139340,-7456127599158839721,-7441400889313937132,-7358868278601709253,-7358060212836203089,-7352752070608668794,-7343187339815468414,-7313632706281829699,-7300818936153065827,-7260464746180664984,-7235342081132170699,-7232956435763801269,-7230501984480900913,-7200014234082843779,-7177172897420730802,-7175711171172305980,-7172250132739505975,-7087535423194362171,-7057915131981856628,-7028329020386561033,-7026314035743879856,-7002777965505184143,-6972353385980469263,-6971181106285617946,-6939372359638838792,-6921952237545611919,-6889893983558684154,-6888097279452081321,-6850397279779714364,-6837733982860208555,-6782521825667717310,-6668287087411217627,-6656952472644555125,-6631147061367006750,-6544856775836905523,-6522381615919551741,-6499317534067935439,-6456897012717022189,-6445619764129977482,-6425395770955125817,-6424875292007817666,-6417617893683967165,-6397519226488068933,-6387249254398552482,-6384764495441758937,-6383620030172774876,-6383096162469735085,-6377092247275381996,-6374552413521970813,-6327339895234934071,-6319255702794143599,-6307315346869670681,-6304223474502277253,-6272197342827125462,-6254579201864627912,-6201562455860377545,-6144411352721244947,-6143102281542538436,-6108558020901053933,-6099820569559912708,-6031899386573252666,-6015557389165032584,-5996038974444068111,-5989662906011178322,-5978005910624011913,-5969452424909193739,-5955758465212209698,-5953318614784889289,-5875864254229201602,-5873081750777084160,-5842774109094536489,-5798523477119973538,-5722882253344355040,-5718087075960060655,-5688649375973571437,-5672133385931132036,-5667126615327186755,-5628831770914307904,-5620331545358224583,-5594429505150293020,-5589751503980716127,-5584991410311322403,-5572012007767602741,-5569730041573603698,-5527049676962861548,-5500132352228195686,-5495492351079134628,-5483115870025147399,-5461533733138737720,-5455442397495943907,-5445520543819877374,-5432646151900825765,-5416441912351664727,-5410836169511336886,-5407364945483888302,-5333527989311484909,-5325463614004874721,-5305495772536573249,-5301719648542291372,-5277562503992534017,-5275275443927460458,-5234467794201871882,-5227660481907997451,-5211561645976087365,-5199681881776895842,-5187258548705525512,-5123551545445585711,-5116035130649597521,-5098818443421800597,-5084872365024117097,-5055386226017426817,-5027819071940633643,-5022586051426445741,-4984696279286547627,-4960744695627668691,-4936626049318532267,-4909357043467148154,-4888236434493111323,-4888041052754396930,-4884599880848287628,-4845022388102275978,-4786046747103169214,-4775067399778981473,-4764175047698144762,-4674765489842353474,-4646015498958498841,-4636030074974022602,-4619431625209188907,-4610335088169767486,-4603865302817108777,-4595120071081826333,-4578496201354130477,-4520569951483935752,-4513337416920346891,-4463616495696529074,-4462981119032467258,-4442850879284892214,-4434075595428270488,-4432721070254958973,-4400918682357021152,-4400239339916185067,-4387264764953500555,-4346753332850413793,-4345358338031065493,-4317850912384388414,-4310562551399006559,-4277688513529944548,-4216362802654972752,-4202556919529362451,-4194750441847170745,-4184777600067865439,-4165079757389035104,-4154969540005734582,-4137844385689762683,-4122918136545251887,-4115263274542542434,-4099453298896582184,-4087344602559099049,-4060574624273014876,-4025236984621622276,-3950860769610432441,-3923477892547528003,-3923241611662686225,-3865686479935809854,-3819786685725750176,-3812428629760683465,-3777945684552133018,-3748856586166712449,-3746600396420650765,-3746447404193361333,-3730492760031867479,-3727777456163925313,-3716942315642673781,-3707533783294922356,-3698000307223331744,-3656915453844252216,-3628491298909130367,-3604716804580123976,-3603827758720018829,-3603012747938047663,-3596003570601591232,-3584514803957411484,-3576157178873925528,-3545783215934887858,-3535354865686962657,-3530821784290455563,-3529407571489553366,-3526808374381119904,-3510807290522313119,-3493299788783170935,-3446233294084436834,-3393518780851457134,-3390351664363174686,-3368408813973141438,-3367295249088175594,-3350492443180217613,-3346731465506630745,-3345751537427371444,-3337605284370972919,-3326652703492431370,-3287568976935609810,-3282901485633249899,-3271705212845786463,-3215999014584047144,-3205629834416103452,-3202031330184306011,-3184460689784328368,-3179310378102587308,-3164479009823107764,-3133007145867425238,-3103384747956975302,-3102560374073029056,-3084548561917455746,-3069820604374789964,-3063040163754100728,-3059836954225704709,-3039331318513925741,-3037212624631867835,-3032862074331397994,-3028484819862778292,-3011900193558343752,-3003113364739286698,-2990250436177653203,-2978658613134234438,-2959300011101981319,-2942179950657083936,-2930830129439730547,-2928304215784255710,-2883835079933567303,-2875192552407466390,-2851516855984300717,-2842025939076670853,-2712159819901884212,-2706220443538645132,-2650565697240259240,-2646362723170919559,-2635364456367740888,-2628345013979102311,-2623908982423083999,-2613226492676533066,-2608887364930955926,-2606932115160892203,-2605499431708593753,-2592130015165086596,-2576018828958071307,-2561270480898604290,-2540654167308478608,-2538836078392347995,-2538349605114696293,-2497603187069540912,-2497330602689524363,-2495304279244451346,-2477657756915966948,-2449793062356409718,-2435352880611965007,-2431582801831458325,-2424422453348096606,-2399618206781804055,-2348701344703126961,-2342233247285841116,-2334846393339682869,-2305108979599954353,-2297737349284507423,-2278112880253671545,-2254377000130293741,-2229070627155547571,-2220323327377328888,-2218620365960500411,-2207477688341859302,-2194832995218761026,-2123283726181580274,-2114804634177454926,-2112355631103203831,-2096634055165890873,-2055545512381033091,-2047909357254769721,-2046363279336034706,-2014258327951756456,-1974156842947678741,-1971689850262132865,-1969860388183619970,-1930582518995811786,-1914523085402213344,-1901057046370824358,-1889012824439441642,-1875274286928054227,-1850085270558063601,-1830694054436430771,-1795894157488521601,-1782085693067366794,-1767451912009583680,-1744923354493466053,-1694542678180427158,-1688177897009935143,-1680486057196925483,-1659258171985259490,-1637281363170546147,-1583128050403977853,-1551421090983686799,-1526688396984970949,-1489587659461564513,-1484822585738620282,-1393327115595186133,-1388613968433195442,-1369097480020137310,-1360860838669672015,-1296288843702217926,-1277553368991442711,-1275412467807217138,-1247401932196878966,-1245106533387529602,-1240483201136984730,-1239845923935022009,-1221736909466444560,-1210303116686361159,-1204369167056783616,-1202243659155788341,-1189982788788688367,-1183928381563684342,-1142608555127538913,-1127394555954812482,-1087347035489618204,-1084371452419255179,-1057431636912345048,-1049782242445788933,-1021763870606297764,-1011899844822446421,-1005907487475531378,-1000811069465175612,-977363557850143907,-942104267605295365,-908768162801229997,-881857059375376476,-844981903889571778,-840209356865051107,-823471386143269649,-814959667164761872,-790704755509364433,-782695510834383661,-780582451993514427,-780560751501436862,-750087780201514080,-749538571993128889,-749396418200642554,-745489687523793317,-745372015236471182,-724823435958133573,-715109838286030780,-698479730069502153,-675358964943428916,-673127516550086245,-668325372674305522,-658131057025765067,-650516707619101459,-632145176252631125,-626180450794061639,-618496097167631137,-606254543567105898,-558463679785537661,-529557166183632058,-513568847067534711,-481765174964325996,-446734290720174887,-408047237562045575,-394374016276936155,-378038710480110815,-377937075726171684,-373956095221159972,-329155202762989860,-320723516831364487,-306623965166306889,-296579506394377680,-296070883797070542,-289340514296926648,-272852227010330947,-258197421923096157,-253795108271690398,-237555866612645913,-227343211310236838,-221004500795244243,-145526970241672476,-138151431475401086,-60943230306655783,-59899128471342677,-47296509177136383,-33599240181954269,-27553085801191123,-10824068008798222,-8549568673874260,5340977509611920,21960949524002387,22696831356765056,29971360291729138,74858522138097166,85605230738194611,110827473235194053,112996897520453178,146588419585913813,167142683297950513,183403387076522280,192306442915096600,198300690062410283,203275512302116283,209286153467888168,237160919804586774,243217695722590458,254101736976674059,270485855458779283,280258863730931127,287221169722500380,298949401994710511,299550936199133500,301152993012176866,302524498471570252,334657375951739314,337643606329348313,355184031397952246,379010574695454804,418385611836243073,425040060752872058,430487968752388952,478773139893261435,505014487320301063,519090364940364789,541073521766400394,542346441922497909,597021535021665678,605503719426443346,633179932166241672,680945661602507997,682399165071698282,683022820678304430,716443436067696707,792183925904254677,822521510185601721,830852598605989956,838608706665073353,851865527612312461,861776156303494357,881226024957499523,888173931958531411,890342701256152371,891347993463278861,964291381139639895,990491900288050281,1002818767639071851,1028642960955582164,1033697796914683297,1039642973676629124,1069400217435540642,1090363758226428247,1113857524853717119,1130191381087719878,1140367238969866798,1141771057868593281,1184958468811310067,1206250089688937453,1209183435720374068,1212033022791659130,1221624464195493924,1246477358089548284,1249548135559991893,1264110522965215022,1294029546523269648,1318696486205581479,1321416370691989894,1359760100805180837,1360738905741720025,1372673154174887805,1373158087694714706,1400897454127834856,1435007030612592205,1454234783294726775,1456651464339659767,1471786517100716206,1483992220328679063,1504649707944990114,1505831986401950599,1584644840711803751,1616897722664786906,1658015969675910584,1670615601796986755,1707846235180310608,1708478981156317499,1721179318163636652,1724526208357341089,1740233855606732695,1749340402145748742,1766651068288369852,1770298245617934538,1777006603238435182,1779612781870841347,1808441613938843775,1810131952348009518,1883050143401555503,1889089047820789321,1895793965145564259,1933562064204779493,1936984348844404660,1946405063962209148,1954762431345657550,1959469681471404303,1969795595947704598,1979206378875930767,1993488395064494769,2015772264231480317,2019599361296514602,2021667434297877586,2070332893409002733,2081440693472786669,2095856108094506931,2098327939098573416,2100211805953579419,2139888145997942206,2159325584919325408,2191875180567431826,2248234944822069871,2259726286319292766,2267225832499222641,2269990855297652663,2280986137075201664,2299982202375963423,2303601427839631861,2334780703448578143,2386801780195248719,2408776877452084215,2422169134810409480,2459531435741507669,2462379154487381815,2469107355012068179,2481267977910504854,2490641005633250024,2493120071566359472,2543833906804675881,2544344341892382157,2576362669550887746,2689722915557869069,2714222940767471475,2719403704005636075,2743335659510374591,2745302338277865986,2771330597824922624,2777943518377791495,2788945558339266087,2796919476631795009,2802533727868917636,2844688996406360879,2909161302255286255,2912336119680176355,2921168432558844755,2935039535273195860,2937909899411363697,2942113640138365099,3011520418840985058,3053744244182889873,3057156538650390878,3086850405375916654,3093325956767291668,3111884690043267724,3117242564086292593,3135115804480118366,3159049978352824831,3167633776036553906,3203262120676785469,3212753887994577915,3231624827033928370,3253211312608772180,3256160721943597235,3268466743507721534,3285758004836249336,3334052912744175721,3342247570460784866,3349187890342716305,3377283464823509630,3391608418136130914,3391638496027475632,3394914172958658136,3407697996193604923,3409326265397177607,3437625936173523599,3448115284024315812,3471177776725596894,3477527845370485406,3481757192892905186,3500808502642803564,3510417310882801769,3528461775782762944,3546111285284377465,3553760325413358835,3589203918442101549,3591805780598613990,3606478285384565600,3621574309472389217,3635339046489303232,3731243642155580056,3738064226002254027,3758864926128774742,3763954141422627952,3773921459830768142,3804746511682493433,3807736918948483517,3816260232281937041,3839571721218258920,3844587025989004423,3854211356362276912,3855841221158686175,3879338984284318080,3916788967658912259,3944745581680376054,3953046841319472119,3958992434696522634,3991109328330820017,3991652134840354815,3994960163865861764,4024240746276691337,4032583809159605500,4050379090991986467,4077464092562039375,4078523931280655259,4089880126279369958,4107586555280491244,4126808610643924005,4151821027314162176,4160967693456641169,4176549759174525435,4199948838211823825,4203513661046516414,4207097865072797328,4218823997089564425,4244611536868342934,4244721647806570056,4298443149772034116,4348096186359032150,4353364595533185039,4385588239267517405,4415147580122149096,4418640030044075132,4455190517821376672,4462752609952016978,4470075820574733311,4486106625839809616,4490661800720960368,4492359599546716639,4494773390056023087,4499637302487333449,4504984628008149988,4505026169256912820,4512833849539358206,4515677110074308730,4564698382092990088,4566045882792319840,4569597558629239163,4572485390536091702,4574989754024520684,4578389094769289193,4580422019630754732,4604245996665199149,4651419239316467781,4651499875810994284,4666329511057608257,4701216547131415614,4729347798037217822,4735122308643162833,4746140079045472456,4763938947203593127,4765150010756642430,4772184964541036220,4779646993888068991,4803375651967406550,4834278881425622853,4834971695136800607,4840089921014273394,4858863292665525894,4871316776643273150,4873497576238431816,4875953131336565014,4878342242770665586,4878830915088781160,4896917544012636537,4909232623733671590,4922019011084142453,4926980192400987803,4942809274358478394,4958208433167762938,4959504947911337564,4971796652089941712,4998844534114647709,5024638295202238559,5073564420065866105,5129169155373685727,5149359810751505020,5154163704840154938,5171451444267939820,5179994649898089483,5211461770025271332,5218049620657835075,5244900905458570281,5277524263452236343,5383513727406449671,5401457435880156992,5427238262572519423,5449447052976167638,5461383607824821940,5482197583799159907,5493307881405987488,5503537497666974357,5515975137386362573,5519375560471376200,5538932980243068512,5550219939827161685,5556712203067061945,5572095740958051367,5607350405486924147,5629053642071395755,5645600704297906419,5690737622594475606,5700094486081311045,5709121235798494518,5730438714729076477,5751625599862093794,5753569914559850841,5765910147953691883,5769127301202529231,5796433119506661864,5803295162997081453,5810502835947942739,5871208273529538668,5886365780555331675,5889701767889236231,5890928901188175333,5901588434154866890,5940215307907801783,5960020845586849615,5975578923724673871,5996496297550822882,6000499712993067085,6038229474874195363,6039778389641028791,6059338109385706266,6062473215232236296,6091350589400478336,6105296916908214384,6107491026711180744,6110708411890067016,6122994644237500114,6129815395589209419,6130428393151050522,6131614528518841401,6151922744513959273,6180243978342353838,6222272604483065959,6226913421682299157,6259701041985631995,6265532740528640396,6273938832549850109,6284247771035086245,6291115531171711720,6347492492609994195,6375836178555624875,6379522384558422383,6397083730576439442,6446649552875040240,6508842559725529199,6540105040239543772,6540147335260965607,6547819508264826693,6585415633340265234,6597480999561108188,6608147982206871202,6621611732002794096,6669430571272763564,6699811240855715953,6734543888826939428,6735963270661431996,6738527893012588964,6740923723975606973,6778347162097118425,6780792050560501572,6780966874277379396,6786763340927955879,6822701342248524130,6829521271107559936,6852046081235387078,6911023118109788292,6919162582917254884,6919377019427505552,6933053419013285412,6943241090295424285,6959325495024290211,6961682406836615307,6966819142020492501,7030052419565469608,7071727878519166808,7108236694050177883,7114933760113279847,7117277960870423636,7143631852353703635,7180228831368312172,7182811662375810127,7193213662793177018,7202002057140064309,7212917696715813352,7218442755816621530,7262219432293673316,7265133712816105003,7273989061932115928,7277779331511881716,7328245727453002559,7330275961496383683,7350293597057688866,7376018756243308631,7397214867038272036,7416183906045815984,7418461126263830703,7424629142705299787,7437576824519811380,7460909627398129284,7489235888525101128,7514457796012013096,7522343297415891102,7532438527393530137,7540093782388822489,7565580425141612097,7586548241605901625,7587947363921120591,7597239278404255498,7597632277429689469,7600070933846741204,7606511987790839226,7607410467620417596,7610907100873226076,7613681342891100827,7623384293255957646,7633341846979554851,7653362811166562184,7656445756374572491,7662297229101752116,7665201740644623106,7665844740935293072,7674458092520256333,7734269115490631421,7735307292372177894,7739229925289881596,7739451781414180573,7759190181786566266,7773602929212723902,7783950653703641671,7800519317637192256,7807399644946468687,7808512118901204407,7853000189263370109,7880299702506189540,7923256486932740491,7933408307842316982,7934629556990014864,7946500192164763878,7960730419232403332,7981126012725952868,7981562447095549217,8006873675568819620,8018036279844180922,8076848556188810264,8081552104023776045,8111308941905101946,8137059048603484212,8138053345608274536,8144207764076892030,8157957971105741047,8175868481369928635,8179045809222865098,8185658295980625657,8194759817368581684,8206213476675355788,8210950542697391993,8221942358409209852,8224075028224215882,8244146503769378228,8252421377070408282,8309910133853266523,8395740051121239522,8402491577795846372,8436178307146390309,8443359089096562323,8459558659979738539,8486191206826815718,8529874389724145696,8532371148913470605,8533389519398355865,8555206601424342362,8560513425086615321,8583665676864330444,8585072659031207390,8630422042432628197,8633692958355289594,8646542041981502598,8667368303805932178,8673753069615639811,8699248351762751838,8709097896951048602,8724548881388782201,8743527824668415385,8747969353825593377,8821992070934698529,8853972767942749393,8862005398897680141,8888867962370777697,8910330210749414551,8915262020702547414,8948027326328656323,8977043298028651336,9031945300320700797,9047474026422316643,9052786087838194469,9062314326156197020,9082272151682368894,9100567942855362371,9106375443363266368,9107332223535159588,9110905101644051380,9128607360199292940,9158049419611684942,9162503831624097287,9174510747177593681,9179431287048349200,9181704916645606503,9189235288047038740,9211098348057740773";

    final String[] split = data.split(",");
    this.ring = new LongArrayList(split.length);
    for (String s : split) {
      this.ring.add(Long.parseLong(s));
    }
    this.ring.sort(LongComparators.NATURAL_COMPARATOR);
  }

  private void putLong(byte[] b, int off, long val) {
    b[off + 7] = (byte) (val);
    b[off + 6] = (byte) (val >>> 8);
    b[off + 5] = (byte) (val >>> 16);
    b[off + 4] = (byte) (val >>> 24);
    b[off + 3] = (byte) (val >>> 32);
    b[off + 2] = (byte) (val >>> 40);
    b[off + 1] = (byte) (val >>> 48);
    b[off] = (byte) (val >>> 56);
  }

  private long[] getHash(long n) {
    ByteBuffer key = ByteBuffer.allocate(8).putLong(0, n);
    long[] hash = new long[2];
    MurmurHash.hash3_x64_128(key, key.position(), key.remaining(), 0, hash);
    return hash;
  }


  public int getPartIdx(long blogId) {
    final long token = getHash(blogId)[0];
    for (int i = 0; i < ring.size() - 1; i++) {
      final long left = i == 0 ? Long.MIN_VALUE : ring.getLong(i - 1);
      final long right = ring.getLong(i);
      if (token >= left && token < right) {
        System.err.printf(
            "find , left:%s, right:%s, token:%s \n", left, right, token
        );
        return i;
      }
    }
    return ring.size();
  }

  public static void main(String[] args) {
    final CassandraTools cassandraTools = new CassandraTools();
    final LongArrayList ring = cassandraTools.ring;
    System.out.println(ring.size());
//    System.err.println(cassandraTools.getPartIdx(1310533353));
//    System.err.println(cassandraTools.getPartIdx(54917156));
//    System.err.println(cassandraTools.getPartIdx(1310504674));
    System.err.println(cassandraTools.getPartIdx(425791996L));
  }
}
